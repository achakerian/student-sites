<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Sites</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="api.js"></script>
</head>
<body data-theme="dark">
  <header>
    <button class="brand" id="home-btn">Student Sites</button>
    <nav class="navbar">
      <div class="search-container">
        <input type="text" id="search-input" placeholder="Search sites..." />
        <span class="search-icon">üîç</span>
      </div>
      <div class="nav-buttons">
        <button onclick="window.location.href='about.html'" aria-label="About this site">‚ÑπÔ∏è</button>
        <button id="theme-toggle" aria-label="Toggle light/dark mode">‚òÄÔ∏è</button>
        <button id="index-btn" aria-label="View all sites">üìã</button>
      </div>
    </nav>
  </header>

  <main>
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container">
        <h1>Student Sites</h1>
        <p class="hero-description">
          Discover innovative web development projects created with <strong>energy</strong> and passion.
          This platform showcases student work in <strong>education</strong>, technology, and creative design.
          Explore portfolios, experiments, and interactive experiences built with modern web technologies.
          Browse through projects that demonstrate creativity, technical skill, and innovative thinking.
        </p>
      </div>
    </section>

    <!-- Student Grid -->
    <section class="container">
      <ul class="grid" role="list" id="sites-grid">
        <!-- Sites will be loaded here -->
      </ul>

      <!-- Loading indicator -->
      <div id="loading-indicator" class="loading-indicator">
        <p>Loading student sites...</p>
      </div>
    </section>

    <!-- Iframe Modal -->
    <div id="iframe-modal" class="iframe-modal">
      <div class="iframe-modal-content">
        <div class="iframe-modal-header">
          <h3 id="iframe-modal-title">Site Title</h3>
          <button id="iframe-modal-close" class="iframe-modal-close">&times;</button>
        </div>
        <iframe id="iframe-modal-frame" src="" frameborder="0"></iframe>
      </div>
    </div>
  </main>

  <script>
    // Theme toggle functionality
    const themeToggle = document.getElementById("theme-toggle");
    const body = document.body;

    themeToggle.addEventListener("click", () => {
      const isDark = body.getAttribute("data-theme") === "dark";
      body.setAttribute("data-theme", isDark ? "light" : "dark");
      themeToggle.textContent = isDark ? "üåô" : "‚òÄÔ∏è";
    });

    // Home button functionality
    const homeBtn = document.getElementById("home-btn");
    homeBtn.addEventListener("click", () => {
      if (isIndexView) {
        toggleIndexView(); // Switch back to grid view
      }
      // Clear search
      searchInput.value = "";
      performSearch("");
    });

    // Index button functionality
    const indexBtn = document.getElementById("index-btn");
    let isIndexView = false;

    indexBtn.addEventListener("click", () => {
      toggleIndexView();
    });

    function toggleIndexView() {
      const sitesGrid = document.getElementById("sites-grid");
      const cards = sitesGrid.querySelectorAll(".card");

      if (!isIndexView) {
        // Switch to index list view
        sitesGrid.classList.add("index-view");
        indexBtn.textContent = "üî≤";
        indexBtn.setAttribute("aria-label", "View grid");
        isIndexView = true;

        // Create index list if it doesn't exist
        let indexList = document.getElementById("index-list");
        if (!indexList) {
          indexList = document.createElement("div");
          indexList.id = "index-list";
          indexList.className = "index-list";
          sitesGrid.parentNode.insertBefore(indexList, sitesGrid);
        }

        // Populate index list - alphabetical directory
        const sites = Array.from(cards).map(card => {
          const link = card.querySelector("a");
          const title = card.querySelector("h3").textContent;
          const tags = Array.from(card.querySelectorAll(".tag"));
          const primaryTag = tags.length > 0 ? tags[0].textContent : "Website";
          const url = link.getAttribute("href");

          return {
            title,
            url,
            tag: primaryTag,
            searchText: `${title.toLowerCase()} ${primaryTag.toLowerCase()}`
          };
        }).sort((a, b) => a.title.localeCompare(b.title));

        const indexHTML = sites.map(site => `
          <div class="index-item" data-search-text="${site.searchText}">
            <a href="${site.url}" data-iframe="true" class="index-link">${site.title}</a>
            <span class="index-tag">${site.tag}</span>
          </div>
        `).join('');

        indexList.innerHTML = `
          <h2 class="index-heading">Site Index</h2>
          ${indexHTML}
        `;

        // Hide grid, show index
        sitesGrid.style.display = "none";
        indexList.style.display = "block";

        // Apply current search term to index view
        const currentSearch = searchInput.value.toLowerCase();
        if (currentSearch) {
          performSearch(currentSearch);
        }
      } else {
        // Switch back to grid view
        sitesGrid.classList.remove("index-view");
        indexBtn.textContent = "üìã";
        indexBtn.setAttribute("aria-label", "View all sites");
        isIndexView = false;

        // Show grid, hide index
        sitesGrid.style.display = "grid";
        const indexList = document.getElementById("index-list");
        if (indexList) {
          indexList.style.display = "none";
        }

        // Apply current search term to grid view
        const currentSearch = searchInput.value.toLowerCase();
        if (currentSearch) {
          performSearch(currentSearch);
        }
      }
    }

    // Enhanced search functionality
    const searchInput = document.getElementById("search-input");
    searchInput.addEventListener("input", (e) => {
      const searchTerm = e.target.value.toLowerCase();
      performSearch(searchTerm);
    });

    function performSearch(searchTerm) {
      if (isIndexView) {
        // Search in index view
        const indexItems = document.querySelectorAll(".index-item");
        let visibleCount = 0;

        indexItems.forEach(item => {
          const searchText = item.getAttribute("data-search-text") || "";

          if (!searchTerm || searchText.includes(searchTerm)) {
            item.style.display = "flex";
            visibleCount++;
          } else {
            item.style.display = "none";
          }
        });

      } else {
        // Search in grid view
        const cards = document.querySelectorAll(".card");

        cards.forEach(card => {
          const title = card.querySelector("h3")?.textContent.toLowerCase() || "";
          const description = card.querySelector(".muted")?.textContent.toLowerCase() || "";
          const tags = Array.from(card.querySelectorAll(".tag")).map(tag => tag.textContent.toLowerCase()).join(" ");

          if (!searchTerm || title.includes(searchTerm) || description.includes(searchTerm) || tags.includes(searchTerm)) {
            card.style.display = "block";
          } else {
            card.style.display = "none";
          }
        });
      }
    }

    // Dynamic site loading
    async function loadStudentSites() {
      const sitesGrid = document.getElementById("sites-grid");
      const loadingIndicator = document.getElementById("loading-indicator");

      try {
        const api = new StudentSitesAPI();
        const sites = await api.loadSites();

        // Generate and append dynamic sites
        const dynamicSitesHTML = api.generateSiteGrid(sites);
        sitesGrid.insertAdjacentHTML('beforeend', dynamicSitesHTML);

        // Hide loading indicator
        loadingIndicator.style.display = 'none';

        console.log(`Loaded ${sites.length} student sites`);
      } catch (error) {
        console.error('Error loading student sites:', error);
        loadingIndicator.style.display = 'none';
      }
    }

    // Iframe modal functionality
    const iframeModal = document.getElementById('iframe-modal');
    const iframeModalTitle = document.getElementById('iframe-modal-title');
    const iframeModalFrame = document.getElementById('iframe-modal-frame');
    const iframeModalClose = document.getElementById('iframe-modal-close');

    function openIframeModal(url, title) {
      iframeModalTitle.textContent = "Student site preview";
      iframeModalFrame.src = url;
      iframeModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeIframeModal() {
      iframeModal.style.display = 'none';
      iframeModalFrame.src = '';
      document.body.style.overflow = 'auto';
    }

    // Close modal when clicking close button
    iframeModalClose.addEventListener('click', closeIframeModal);

    // Close modal when clicking outside of it
    iframeModal.addEventListener('click', (e) => {
      if (e.target === iframeModal) {
        closeIframeModal();
      }
    });

    // Close modal with escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && iframeModal.style.display === 'block') {
        closeIframeModal();
      }
    });

    // Handle link clicks to open in iframe modal
    document.addEventListener('click', (e) => {
      const link = e.target.closest('a[data-iframe="true"]');
      const button = e.target.closest('button[data-iframe="true"]');

      if (link) {
        e.preventDefault();
        const url = link.getAttribute('href');
        const title = link.textContent || 'Student Site';
        openIframeModal(url, title);
      } else if (button) {
        e.preventDefault();
        const url = button.getAttribute('data-url');
        const title = button.closest('.card').querySelector('h3').textContent || 'Student Site';
        openIframeModal(url, title);
      }
    });

    // Load sites when page loads
    document.addEventListener('DOMContentLoaded', loadStudentSites);
  </script>
</body>
</html>